import { __assign } from "tslib";
import { Injectable } from '@angular/core';
import { HttpEventType, HttpRequest, HttpHeaders, HttpParams } from '@angular/common/http';
import { map, distinctUntilChanged, filter } from 'rxjs/operators';
import { isNullOrUndefined, isUndefined } from 'util';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
/**
 * FileDownload request state enum
 */
export var FileDownloadState;
(function (FileDownloadState) {
    FileDownloadState["initialize"] = "initialize";
    FileDownloadState["inProgress"] = "inProgress";
    FileDownloadState["completed"] = "completed";
})(FileDownloadState || (FileDownloadState = {}));
var FileDownload = /** @class */ (function () {
    /**
     * Service class constructor
     */
    function FileDownload(http) {
        this.http = http;
    }
    /**
     * Convert bytes size to human readable format
     */
    FileDownload.humanReadableFormat = function (bytes) {
        var e = (Math.log(bytes) / Math.log(1e3)) | 0;
        return +(bytes / Math.pow(1e3, e)).toFixed(2) + ' ' + ('kMGTPEZY'[e - 1] || '') + 'B';
    };
    /**
     * Save the Blob data
     */
    FileDownload.blobSave = function (saveAs, data) {
        if (window.navigator && window.navigator.msSaveOrOpenBlob) {
            window.navigator.msSaveOrOpenBlob(data, saveAs);
        }
        else {
            var url_1 = window.URL.createObjectURL(data), a_1 = document.createElement('a');
            document.body.appendChild(a_1);
            a_1.setAttribute('style', 'display: none');
            a_1.href = url_1;
            a_1.download = saveAs;
            a_1.click();
            setTimeout(function () { window.URL.revokeObjectURL(url_1); document.body.removeChild(a_1); }, 400);
        }
    };
    /**
     * Request the file to be downloaded
     */
    FileDownload.prototype.download = function (method, url, saveAs, options) {
        if (options === void 0) { options = {}; }
        method = method.toLowerCase();
        if (['get', 'post', 'put'].indexOf(method) === -1) {
            throw new Error("FileDownload: Method \"" + method + "\" not allow, use \"GET\", \"POST\" or \"PUT\"");
        }
        var result = { state: null, saveAs: saveAs, total: 0, loaded: 0, progress: 0 }, Params = new HttpParams();
        var Options = {
            reportProgress: true,
            headers: new HttpHeaders(options.headers || {})
        };
        if (options.params) {
            Object.keys(options.params).forEach(function (key) { Params = Params.set(key, options.params[key]); });
        }
        var res = method === 'GET'
            ? new HttpRequest(method, url, __assign(__assign({}, Options), { responseType: 'blob', params: Params }))
            : new HttpRequest(method, url, options.params || {}, __assign(__assign({}, Options), { responseType: 'blob' }));
        return this.http
            .request(res)
            .pipe(map(function (event) {
            switch (event.type) {
                case HttpEventType.Sent:
                    result = __assign(__assign({}, result), { state: FileDownloadState.initialize });
                    break;
                case HttpEventType.DownloadProgress:
                    if (!isUndefined(event.total)) {
                        result = __assign(__assign({}, result), {
                            state: FileDownloadState.inProgress,
                            total: event.total,
                            loaded: event.loaded,
                            progress: Math.round(100 * event.loaded / event.total)
                        });
                    }
                    break;
                case HttpEventType.Response:
                    if (result.state !== FileDownloadState.completed) {
                        result = __assign(__assign({}, result), { state: FileDownloadState.completed });
                        FileDownload.blobSave(saveAs, event.body);
                    }
                    break;
            }
            return result;
        }), filter(function (val) { return !isNullOrUndefined(val); }), distinctUntilChanged());
    };
    /**
     * Upload the files using POST HTTP method
     */
    FileDownload.prototype.get = function (url, saveAs, options) {
        if (options === void 0) { options = {}; }
        return this.download('get', url, saveAs, options);
    };
    /**
     * Upload the files using POST HTTP method
     */
    FileDownload.prototype.post = function (url, saveAs, options) {
        if (options === void 0) { options = {}; }
        return this.download('post', url, saveAs, options);
    };
    /**
     * Upload the files using PUT HTTP method
     */
    FileDownload.prototype.put = function (url, saveAs, options) {
        if (options === void 0) { options = {}; }
        return this.download('put', url, saveAs, options);
    };
    /** @nocollapse */ FileDownload.ɵfac = function FileDownload_Factory(t) { return new (t || FileDownload)(i0.ɵɵinject(i1.HttpClient)); };
    /** @nocollapse */ FileDownload.ɵprov = i0.ɵɵdefineInjectable({ token: FileDownload, factory: FileDownload.ɵfac });
    return FileDownload;
}());
export { FileDownload };
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(FileDownload, [{
        type: Injectable
    }], function () { return [{ type: i1.HttpClient }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS1kb3dubG9hZC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXJlc3QvIiwic291cmNlcyI6WyJsaWIvZmlsZS1kb3dubG9hZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBYyxhQUFhLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUV2RyxPQUFPLEVBQUUsR0FBRyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxXQUFXLEVBQUUsTUFBTSxNQUFNLENBQUM7OztBQVV0RDs7R0FFRztBQUNILE1BQU0sQ0FBTixJQUFZLGlCQUlYO0FBSkQsV0FBWSxpQkFBaUI7SUFDekIsOENBQXlCLENBQUE7SUFDekIsOENBQXlCLENBQUE7SUFDekIsNENBQXVCLENBQUE7QUFDM0IsQ0FBQyxFQUpXLGlCQUFpQixLQUFqQixpQkFBaUIsUUFJNUI7QUFFRDtJQUdJOztPQUVHO0lBQ0gsc0JBQXFCLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENBQVk7SUFBTSxDQUFDO0lBRTVDOztPQUVHO0lBQ1csZ0NBQW1CLEdBQWpDLFVBQWtDLEtBQWE7UUFDM0MsSUFBTSxDQUFDLEdBQUcsQ0FBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUUsR0FBRyxDQUFDLENBQUM7UUFDbEQsT0FBTyxDQUFDLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFD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QUVEOztPQUVHO0lBQ0ksMEJBQUcsR0FBVixVQUFZLEdBQVcsRUFBRSxNQUFjLEVBQUUsT0FBOEI7UUFBOUIsd0JBQUEsRUFBQSxZQUE4QjtRQUNuRSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksMkJBQUksR0FBWCxVQUFhLEdBQVcsRUFBRSxNQUFjLEVBQUUsT0FBOEI7UUFBOUIsd0JBQUEsRUFBQSxZQUE4QjtRQUNwRSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksMEJBQUcsR0FBVixVQUFZLEdBQVcsRUFBRSxNQUFjLEVBQUUsT0FBOEI7UUFBOUIsd0JBQUEsRUFBQSxZQUE4QjtRQUNuRSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDdEQsQ0FBQzsrRkFqSFEsWUFBWTsyRUFBWixZQUFZLFdBQVosWUFBWTt1QkF4QnpCO0NBMklDLEFBcEhELElBb0hDO1NBbkhZLFlBQVk7a0RBQVosWUFBWTtjQUR4QixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEV2ZW50VHlwZSwgSHR0cFJlcXVlc3QsIEh0dHBIZWFkZXJzLCBIdHRwUGFyYW1zIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgaXNOdWxsT3JVbmRlZmluZWQsIGlzVW5kZWZpbmVkIH0gZnJvbSAndXRpbCc7XG5cbi8qKlxuICogRmlsZURvd25sb2FkIHJlcXVlc3Qgb3B0aW9ucyBzdHJ1Y3R1cmVcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJRG93bmxvYWRPcHRpb25zIHtcbiAgICBwYXJhbXM/OiB7W2tleTogc3RyaW5nXTogYW55fTtcbiAgICBoZWFkZXJzPzogYW55O1xufVxuXG4vKipcbiAqIEZpbGVEb3dubG9hZCByZXF1ZXN0IHN0YXRlIGVudW1cbiAqL1xuZXhwb3J0IGVudW0gRmlsZURvd25sb2FkU3RhdGUge1xuICAgIGluaXRpYWxpemUgPSAnaW5pdGlhbGl6ZScsXG4gICAgaW5Qcm9ncmVzcyA9ICdpblByb2dyZXNzJyxcbiAgICBjb21wbGV0ZWQgPSAnY29tcGxldGVkJyxcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEZpbGVEb3dubG9hZCB7XG5cbiAgICAvKipcbiAgICAgKiBTZXJ2aWNlIGNsYXNzIGNvbnN0cnVjdG9yXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCApIHsgIH1cblxuICAgIC8qKlxuICAgICAqIENvbnZlcnQgYnl0ZXMgc2l6ZSB0byBodW1hbiByZWFkYWJsZSBmb3JtYXRcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGh1bWFuUmVhZGFibGVGb3JtYXQoYnl0ZXM6IG51bWJlcikge1xuICAgICAgICBjb25zdCBlID0gKCBNYXRoLmxvZyhieXRlcykgLyBNYXRoLmxvZygxZTMpICkgfCAwO1xuICAgICAgICByZXR1cm4gKyhieXRlcyAvIE1hdGgucG93KDFlMywgZSkpLnRvRml4ZWQoMikgKyAnICcgKyAoJ2tNR1RQRVpZJ1tlIC0gMV0gfHwgJycpICsgJ0InO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNhdmUgdGhlIEJsb2IgZGF0YVxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgYmxvYlNhdmUoIHNhdmVBczogc3RyaW5nLCBkYXRhOiBhbnkgKSB7XG5cbiAgICAgICAgaWYgKHdpbmRvdy5uYXZpZ2F0b3IgJiYgd2luZG93Lm5hdmlnYXRvci5tc1NhdmVPck9wZW5CbG9iKSB7XG4gICAgICAgICAgICB3aW5kb3cubmF2aWdhdG9yLm1zU2F2ZU9yT3BlbkJsb2IoZGF0YSwgc2F2ZUFzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHVybCA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGRhdGEpLCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xuXG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGEpO1xuICAgICAgICAgICAgYS5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgJ2Rpc3BsYXk6IG5vbmUnKTtcbiAgICAgICAgICAgIGEuaHJlZiA9IHVybDtcbiAgICAgICAgICAgIGEuZG93bmxvYWQgPSBzYXZlQXM7XG4gICAgICAgICAgICBhLmNsaWNrKCk7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgd2luZG93LlVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChhKTsgfSwgNDAwKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcXVlc3QgdGhlIGZpbGUgdG8gYmUgZG93bmxvYWRlZFxuICAgICAqL1xuICAgIHByaXZhdGUgZG93bmxvYWQobWV0aG9kOiBzdHJpbmcsIHVybDogc3RyaW5nLCBzYXZlQXM6IHN0cmluZywgb3B0aW9uczogSURvd25sb2FkT3B0aW9ucyA9IHt9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgbWV0aG9kID0gbWV0aG9kLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIGlmICggWyAnZ2V0JywgJ3Bvc3QnLCAncHV0JyBdLmluZGV4T2YoIG1ldGhvZCApID09PSAtMSApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmlsZURvd25sb2FkOiBNZXRob2QgXCIkeyBtZXRob2QgfVwiIG5vdCBhbGxvdywgdXNlIFwiR0VUXCIsIFwiUE9TVFwiIG9yIFwiUFVUXCJgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCByZXN1bHQgPSB7IHN0YXRlOiBudWxsLCBzYXZlQXM6IHNhdmVBcywgdG90YWw6IDAsIGxvYWRlZDogMCwgcHJvZ3Jlc3M6IDAgfSxcbiAgICAgICAgICAgIFBhcmFtcyA9IG5ldyBIdHRwUGFyYW1zKCk7XG5cbiAgICAgICAgY29uc3QgT3B0aW9ucyA9IHtcbiAgICAgICAgICAgIHJlcG9ydFByb2dyZXNzOiB0cnVlLFxuICAgICAgICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKCBvcHRpb25zLmhlYWRlcnMgfHwge30pXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKCBvcHRpb25zLnBhcmFtcyApIHtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKG9wdGlvbnMucGFyYW1zKS5mb3JFYWNoKChrZXkpID0+IHsgUGFyYW1zID0gUGFyYW1zLnNldChrZXksIG9wdGlvbnMucGFyYW1zW2tleV0pOyB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlcyA9IG1ldGhvZCA9PT0gJ0dFVCdcbiAgICAgICAgICAgID8gbmV3IEh0dHBSZXF1ZXN0KG1ldGhvZCwgdXJsLCB7IC4uLk9wdGlvbnMsIC4uLnsgcmVzcG9uc2VUeXBlOiAnYmxvYicsIHBhcmFtczogUGFyYW1zIH0gfSlcbiAgICAgICAgICAgIDogbmV3IEh0dHBSZXF1ZXN0KG1ldGhvZCwgdXJsLCBvcHRpb25zLnBhcmFtcyB8fCB7fSwgeyAuLi5PcHRpb25zLCAuLi57IHJlc3BvbnNlVHlwZTogJ2Jsb2InIH0gfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgICAgICAgLnJlcXVlc3QocmVzKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKCggZXZlbnQgKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZXZlbnQudHlwZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBIdHRwRXZlbnRUeXBlLlNlbnQ6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0geyAuLi5yZXN1bHQsIC4uLnsgc3RhdGU6IEZpbGVEb3dubG9hZFN0YXRlLmluaXRpYWxpemUgfSB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBIdHRwRXZlbnRUeXBlLkRvd25sb2FkUHJvZ3Jlc3M6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCAhaXNVbmRlZmluZWQoZXZlbnQudG90YWwpICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5yZXN1bHQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi57XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGU6IEZpbGVEb3dubG9hZFN0YXRlLmluUHJvZ3Jlc3MsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWw6IGV2ZW50LnRvdGFsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRlZDogZXZlbnQubG9hZGVkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzOiBNYXRoLnJvdW5kKDEwMCAqIGV2ZW50LmxvYWRlZCAvIGV2ZW50LnRvdGFsKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgSHR0cEV2ZW50VHlwZS5SZXNwb25zZTpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHJlc3VsdC5zdGF0ZSAhPT0gRmlsZURvd25sb2FkU3RhdGUuY29tcGxldGVkICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB7IC4uLnJlc3VsdCwgLi4ueyBzdGF0ZTogRmlsZURvd25sb2FkU3RhdGUuY29tcGxldGVkIH0gfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRmlsZURvd25sb2FkLmJsb2JTYXZlKCBzYXZlQXMsIGV2ZW50LmJvZHkgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBmaWx0ZXIoKHZhbCkgPT4gIWlzTnVsbE9yVW5kZWZpbmVkKHZhbCkpLFxuICAgICAgICAgICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKClcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBsb2FkIHRoZSBmaWxlcyB1c2luZyBQT1NUIEhUVFAgbWV0aG9kXG4gICAgICovXG4gICAgcHVibGljIGdldCggdXJsOiBzdHJpbmcsIHNhdmVBczogc3RyaW5nLCBvcHRpb25zOiBJRG93bmxvYWRPcHRpb25zID0ge30gKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG93bmxvYWQoJ2dldCcsIHVybCwgc2F2ZUFzLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGxvYWQgdGhlIGZpbGVzIHVzaW5nIFBPU1QgSFRUUCBtZXRob2RcbiAgICAgKi9cbiAgICBwdWJsaWMgcG9zdCggdXJsOiBzdHJpbmcsIHNhdmVBczogc3RyaW5nLCBvcHRpb25zOiBJRG93bmxvYWRPcHRpb25zID0ge30gKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG93bmxvYWQoJ3Bvc3QnLCB1cmwsIHNhdmVBcywgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBsb2FkIHRoZSBmaWxlcyB1c2luZyBQVVQgSFRUUCBtZXRob2RcbiAgICAgKi9cbiAgICBwdWJsaWMgcHV0KCB1cmw6IHN0cmluZywgc2F2ZUFzOiBzdHJpbmcsIG9wdGlvbnM6IElEb3dubG9hZE9wdGlvbnMgPSB7fSApOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kb3dubG9hZCgncHV0JywgdXJsLCBzYXZlQXMsIG9wdGlvbnMpO1xuICAgIH1cblxufVxuIl19