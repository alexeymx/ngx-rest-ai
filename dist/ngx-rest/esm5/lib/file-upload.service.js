import { __assign, __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { HttpClient, HttpEventType, HttpRequest, HttpHeaders } from '@angular/common/http';
import { map, distinctUntilChanged, filter } from 'rxjs/operators';
import { isNullOrUndefined } from 'util';
/**
 * FileUpload request state enum
 */
export var FileUploadState;
(function (FileUploadState) {
    FileUploadState["initialize"] = "initialize";
    FileUploadState["inProgress"] = "inProgress";
    FileUploadState["completed"] = "completed";
})(FileUploadState || (FileUploadState = {}));
var FileUpload = /** @class */ (function () {
    /**
     * Service class constructor
     */
    function FileUpload(http) {
        this.http = http;
    }
    /**
     * Convert bytes size to human readable format
     */
    FileUpload.humanReadableFormat = function (bytes) {
        var e = (Math.log(bytes) / Math.log(1e3)) | 0;
        return +(bytes / Math.pow(1e3, e)).toFixed(2) + ' ' + ('kMGTPEZY'[e - 1] || '') + 'B';
    };
    /**
     * Convert bytes size to human readable format
     */
    FileUpload.calculateSize = function (files) {
        var size = 0;
        Array.from(files).forEach(function (file) { size += file.size; });
        return size;
    };
    /**
     * Create a FormData object to be send as request payload data
     */
    FileUpload.prototype.createFormData = function (object, form, namespace) {
        var formData = form || new FormData();
        for (var property in object) {
            if (!object.hasOwnProperty(property) || !object[property]) {
                continue;
            }
            var formKey = namespace ? namespace + "[" + property + "]" : property;
            if (object[property] instanceof Date) {
                formData.append(formKey, object[property].toISOString());
            }
            else if (object[property] instanceof FileList) {
                for (var i = 0; i < object[property].length; i++) {
                    formData.append(property + "[]", object[property].item(i));
                }
            }
            else if (typeof object[property] === 'object' && !(object[property] instanceof File)) {
                this.createFormData(object[property], formData, formKey);
            }
            else {
                formData.append(formKey, object[property]);
            }
        }
        return formData;
    };
    /**
     * Upload the file list
     */
    FileUpload.prototype.upload = function (method, url, files, options) {
        method = method.toLowerCase();
        if (['post', 'put'].indexOf(method) === -1) {
            throw new Error("FileUpload: Method \"" + method + "\" not allow, use \"POST\" or \"PUT\"");
        }
        var result = { state: null, files: files, total: 0, loaded: 0, progress: 0 };
        var Params = {};
        Params[options.listParameterName ? options.listParameterName : 'files'] = files;
        var res = new HttpRequest(method, url, this.createFormData(options.params ? __assign(__assign({}, Params), options.params) : Params), { reportProgress: true, headers: new HttpHeaders(options.headers ? options.headers : {}) });
        return this.http
            .request(res)
            .pipe(map(function (event) {
            switch (event.type) {
                case HttpEventType.Sent:
                    result = __assign(__assign({}, result), { state: FileUploadState.initialize });
                    break;
                case HttpEventType.UploadProgress:
                    result = __assign(__assign({}, result), {
                        state: event.total !== event.loaded ? FileUploadState.inProgress : FileUploadState.completed,
                        total: event.total,
                        loaded: event.loaded,
                        progress: Math.round(100 * event.loaded / event.total)
                    });
                    break;
                case HttpEventType.Response:
                    if (result.state !== FileUploadState.completed) {
                        result = __assign(__assign({}, result), { state: FileUploadState.completed });
                    }
                    break;
            }
            return result;
        }), filter(function (val) { return !isNullOrUndefined(val); }), distinctUntilChanged());
    };
    /**
     * Upload the files using POST HTTP method
     */
    FileUpload.prototype.post = function (url, files, options) {
        return this.upload('post', url, files, options);
    };
    /**
     * Upload the files using PUT HTTP method
     */
    FileUpload.prototype.put = function (url, files, options) {
        return this.upload('put', url, files, options);
    };
    FileUpload.ctorParameters = function () { return [
        { type: HttpClient }
    ]; };
    FileUpload = __decorate([
        Injectable()
    ], FileUpload);
    return FileUpload;
}());
export { FileUpload };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS11cGxvYWQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1yZXN0LyIsInNvdXJjZXMiOlsibGliL2ZpbGUtdXBsb2FkLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxhQUFhLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRTNGLE9BQU8sRUFBRSxHQUFHLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sTUFBTSxDQUFDO0FBV3pDOztHQUVHO0FBQ0gsTUFBTSxDQUFOLElBQVksZUFJWDtBQUpELFdBQVksZUFBZTtJQUN2Qiw0Q0FBeUIsQ0FBQTtJQUN6Qiw0Q0FBeUIsQ0FBQTtJQUN6QiwwQ0FBdUIsQ0FBQTtBQUMzQixDQUFDLEVBSlcsZUFBZSxLQUFmLGVBQWUsUUFJMUI7QUFHRDtJQUVJOztPQUVHO0lBQ0gsb0JBQXFCLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENBQVk7SUFBTSxDQUFDO0lBRTVDOztPQUVHO0lBQ1csOEJBQW1CLEdBQWpDLFVBQWtDLEtBQWE7UUFDM0MsSUFBTSxDQUFDLEdBQUcsQ0FBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUUsR0FBRyxDQUFDLENBQUM7UUFDbEQsT0FBTyxDQUFDLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLEdBQUcsR0FB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LENBQUMsU0FBUyxFQUFHO3dCQUM5QyxNQUFNLHlCQUFRLE1BQU0sR0FBSyxFQUFFLEtBQUssRUFBRSxlQUFlLENBQUMsU0FBUyxFQUFFLENBQUUsQ0FBQztxQkFDbkU7b0JBQ0QsTUFBTTthQUNiO1lBQ0QsT0FBTyxNQUFNLENBQUM7UUFDbEIsQ0FBQyxDQUFDLEVBQ0YsTUFBTSxDQUFDLFVBQUMsR0FBRyxJQUFLLE9BQUEsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsRUFBdkIsQ0FBdUIsQ0FBQyxFQUN4QyxvQkFBb0IsRUFBRSxDQUN6QixDQUFDO0lBQ1YsQ0FBQztJQUVEOztPQUVHO0lBQ0kseUJBQUksR0FBWCxVQUFhLEdBQVcsRUFBRSxLQUFlLEVBQUUsT0FBd0I7UUFDL0QsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3BELENBQUM7SUFFRDs7T0FFRztJQUNJLHdCQUFHLEdBQVYsVUFBWSxHQUFXLEVBQUUsS0FBZSxFQUFFLE9BQXdCO1FBQzlELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNuRCxDQUFDOztnQkEvRzBCLFVBQVU7O0lBTDVCLFVBQVU7UUFEdEIsVUFBVSxFQUFFO09BQ0EsVUFBVSxDQXNIdEI7SUFBRCxpQkFBQztDQUFBLEFBdEhELElBc0hDO1NBdEhZLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwRXZlbnRUeXBlLCBIdHRwUmVxdWVzdCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBmaWx0ZXIgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBpc051bGxPclVuZGVmaW5lZCB9IGZyb20gJ3V0aWwnO1xuXG4vKipcbiAqIEZpbGVVcGxvYWQgcmVxdWVzdCBvcHRpb25zIHN0cnVjdHVyZVxuICovXG5leHBvcnQgaW50ZXJmYWNlIElVcGxvYWRPcHRpb25zIHtcbiAgICBsaXN0UGFyYW1ldGVyTmFtZT86IGFueTtcbiAgICBwYXJhbXM/OiB7W2tleTogc3RyaW5nXTogYW55fTtcbiAgICBoZWFkZXJzPzogYW55O1xufVxuXG4vKipcbiAqIEZpbGVVcGxvYWQgcmVxdWVzdCBzdGF0ZSBlbnVtXG4gKi9cbmV4cG9ydCBlbnVtIEZpbGVVcGxvYWRTdGF0ZSB7XG4gICAgaW5pdGlhbGl6ZSA9ICdpbml0aWFsaXplJyxcbiAgICBpblByb2dyZXNzID0gJ2luUHJvZ3Jlc3MnLFxuICAgIGNvbXBsZXRlZCA9ICdjb21wbGV0ZWQnXG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBGaWxlVXBsb2FkIHtcblxuICAgIC8qKlxuICAgICAqIFNlcnZpY2UgY2xhc3MgY29uc3RydWN0b3JcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvciggcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50ICkgeyAgfVxuXG4gICAgLyoqXG4gICAgICogQ29udmVydCBieXRlcyBzaXplIHRvIGh1bWFuIHJlYWRhYmxlIGZvcm1hdFxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgaHVtYW5SZWFkYWJsZUZvcm1hdChieXRlczogbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IGUgPSAoIE1hdGgubG9nKGJ5dGVzKSAvIE1hdGgubG9nKDFlMykgKSB8IDA7XG4gICAgICAgIHJldHVybiArKGJ5dGVzIC8gTWF0aC5wb3coMWUzLCBlKSkudG9GaXhlZCgyKSArICcgJyArICgna01HVFBFWlknW2UgLSAxXSB8fCAnJykgKyAnQic7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ29udmVydCBieXRlcyBzaXplIHRvIGh1bWFuIHJlYWRhYmxlIGZvcm1hdFxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgY2FsY3VsYXRlU2l6ZShmaWxlczogRmlsZUxpc3QpIHtcbiAgICAgICAgbGV0IHNpemUgPSAwO1xuICAgICAgICBBcnJheS5mcm9tKGZpbGVzKS5mb3JFYWNoKChmaWxlKSA9PiB7IHNpemUgKz0gZmlsZS5zaXplOyB9KTtcbiAgICAgICAgcmV0dXJuIHNpemU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgRm9ybURhdGEgb2JqZWN0IHRvIGJlIHNlbmQgYXMgcmVxdWVzdCBwYXlsb2FkIGRhdGFcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgY3JlYXRlRm9ybURhdGEob2JqZWN0OiBhbnksIGZvcm0/OiBGb3JtRGF0YSwgbmFtZXNwYWNlPzogc3RyaW5nKTogRm9ybURhdGEge1xuICAgICAgICBjb25zdCBmb3JtRGF0YSA9IGZvcm0gfHwgbmV3IEZvcm1EYXRhKCk7XG5cbiAgICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBvYmplY3QpIHtcblxuICAgICAgICAgICAgaWYgKCFvYmplY3QuaGFzT3duUHJvcGVydHkocHJvcGVydHkpIHx8ICFvYmplY3RbcHJvcGVydHldKSB7IGNvbnRpbnVlOyB9XG5cbiAgICAgICAgICAgIGNvbnN0IGZvcm1LZXkgPSBuYW1lc3BhY2UgPyBgJHtuYW1lc3BhY2V9WyR7cHJvcGVydHl9XWAgOiBwcm9wZXJ0eTtcbiAgICAgICAgICAgIGlmIChvYmplY3RbcHJvcGVydHldIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZChmb3JtS2V5LCBvYmplY3RbcHJvcGVydHldLnRvSVNPU3RyaW5nKCkpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICggb2JqZWN0W3Byb3BlcnR5XSBpbnN0YW5jZW9mIEZpbGVMaXN0ICkge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb2JqZWN0W3Byb3BlcnR5XS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoYCR7cHJvcGVydHl9W11gLCBvYmplY3RbcHJvcGVydHldLml0ZW0oaSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgICAgICAgICAgdHlwZW9mIG9iamVjdFtwcm9wZXJ0eV0gPT09ICdvYmplY3QnICYmICEob2JqZWN0W3Byb3BlcnR5XSBpbnN0YW5jZW9mIEZpbGUpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVGb3JtRGF0YShvYmplY3RbcHJvcGVydHldLCBmb3JtRGF0YSwgZm9ybUtleSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZChmb3JtS2V5LCBvYmplY3RbcHJvcGVydHldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZm9ybURhdGE7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBsb2FkIHRoZSBmaWxlIGxpc3RcbiAgICAgKi9cbiAgICBwcml2YXRlIHVwbG9hZCggbWV0aG9kOiBzdHJpbmcsIHVybDogc3RyaW5nLCBmaWxlczogRmlsZUxpc3QsIG9wdGlvbnM/OiBJVXBsb2FkT3B0aW9ucyApOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBtZXRob2QgPSBtZXRob2QudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgaWYgKCBbICdwb3N0JywgJ3B1dCcgXS5pbmRleE9mKCBtZXRob2QgKSA9PT0gLTEgKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpbGVVcGxvYWQ6IE1ldGhvZCBcIiR7IG1ldGhvZCB9XCIgbm90IGFsbG93LCB1c2UgXCJQT1NUXCIgb3IgXCJQVVRcImApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHJlc3VsdCA9IHsgc3RhdGU6IG51bGwsIGZpbGVzOiBmaWxlcywgdG90YWw6IDAsIGxvYWRlZDogMCwgcHJvZ3Jlc3M6IDAgfTtcblxuICAgICAgICBjb25zdCBQYXJhbXMgPSB7ICB9O1xuXG4gICAgICAgIFBhcmFtc1tvcHRpb25zLmxpc3RQYXJhbWV0ZXJOYW1lID8gb3B0aW9ucy5saXN0UGFyYW1ldGVyTmFtZSA6ICdmaWxlcyddID0gZmlsZXM7XG5cbiAgICAgICAgY29uc3QgcmVzID0gbmV3IEh0dHBSZXF1ZXN0KFxuICAgICAgICAgICAgbWV0aG9kLCB1cmwsXG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUZvcm1EYXRhKCBvcHRpb25zLnBhcmFtcyA/IHsgLi4uUGFyYW1zLCAuLi5vcHRpb25zLnBhcmFtcyB9IDogUGFyYW1zICksXG4gICAgICAgICAgICB7IHJlcG9ydFByb2dyZXNzOiB0cnVlLCBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnMob3B0aW9ucy5oZWFkZXJzID8gb3B0aW9ucy5oZWFkZXJzIDoge30pIH1cbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAgICAgICAucmVxdWVzdChyZXMpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKCBldmVudCApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChldmVudC50eXBlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEh0dHBFdmVudFR5cGUuU2VudDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB7IC4uLnJlc3VsdCwgLi4ueyBzdGF0ZTogRmlsZVVwbG9hZFN0YXRlLmluaXRpYWxpemUgfSB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBIdHRwRXZlbnRUeXBlLlVwbG9hZFByb2dyZXNzOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4ucmVzdWx0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi57XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZTogZXZlbnQudG90YWwgIT09IGV2ZW50LmxvYWRlZCA/IEZpbGVVcGxvYWRTdGF0ZS5pblByb2dyZXNzIDogRmlsZVVwbG9hZFN0YXRlLmNvbXBsZXRlZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsOiBldmVudC50b3RhbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRlZDogZXZlbnQubG9hZGVkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3M6IE1hdGgucm91bmQoMTAwICogZXZlbnQubG9hZGVkIC8gZXZlbnQudG90YWwpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBIdHRwRXZlbnRUeXBlLlJlc3BvbnNlOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggcmVzdWx0LnN0YXRlICE9PSBGaWxlVXBsb2FkU3RhdGUuY29tcGxldGVkICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB7IC4uLnJlc3VsdCwgLi4ueyBzdGF0ZTogRmlsZVVwbG9hZFN0YXRlLmNvbXBsZXRlZCB9IH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgZmlsdGVyKCh2YWwpID0+ICFpc051bGxPclVuZGVmaW5lZCh2YWwpKSxcbiAgICAgICAgICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwbG9hZCB0aGUgZmlsZXMgdXNpbmcgUE9TVCBIVFRQIG1ldGhvZFxuICAgICAqL1xuICAgIHB1YmxpYyBwb3N0KCB1cmw6IHN0cmluZywgZmlsZXM6IEZpbGVMaXN0LCBvcHRpb25zPzogSVVwbG9hZE9wdGlvbnMgKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMudXBsb2FkKCdwb3N0JywgdXJsLCBmaWxlcywgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBsb2FkIHRoZSBmaWxlcyB1c2luZyBQVVQgSFRUUCBtZXRob2RcbiAgICAgKi9cbiAgICBwdWJsaWMgcHV0KCB1cmw6IHN0cmluZywgZmlsZXM6IEZpbGVMaXN0LCBvcHRpb25zPzogSVVwbG9hZE9wdGlvbnMgKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMudXBsb2FkKCdwdXQnLCB1cmwsIGZpbGVzLCBvcHRpb25zKTtcbiAgICB9XG5cbn1cbiJdfQ==