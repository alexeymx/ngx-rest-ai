import { Injectable } from '@angular/core';
import { HttpEventType, HttpRequest, HttpHeaders } from '@angular/common/http';
import { map, distinctUntilChanged, filter } from 'rxjs/operators';
import { isNullOrUndefined } from 'util';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
/**
 * FileUpload request state enum
 */
export var FileUploadState;
(function (FileUploadState) {
    FileUploadState["initialize"] = "initialize";
    FileUploadState["inProgress"] = "inProgress";
    FileUploadState["completed"] = "completed";
})(FileUploadState || (FileUploadState = {}));
export class FileUpload {
    /**
     * Service class constructor
     */
    constructor(http) {
        this.http = http;
    }
    /**
     * Convert bytes size to human readable format
     */
    static humanReadableFormat(bytes) {
        const e = (Math.log(bytes) / Math.log(1e3)) | 0;
        return +(bytes / Math.pow(1e3, e)).toFixed(2) + ' ' + ('kMGTPEZY'[e - 1] || '') + 'B';
    }
    /**
     * Convert bytes size to human readable format
     */
    static calculateSize(files) {
        let size = 0;
        Array.from(files).forEach((file) => { size += file.size; });
        return size;
    }
    /**
     * Create a FormData object to be send as request payload data
     */
    createFormData(object, form, namespace) {
        const formData = form || new FormData();
        for (const property in object) {
            if (!object.hasOwnProperty(property) || !object[property]) {
                continue;
            }
            const formKey = namespace ? `${namespace}[${property}]` : property;
            if (object[property] instanceof Date) {
                formData.append(formKey, object[property].toISOString());
            }
            else if (object[property] instanceof FileList) {
                for (let i = 0; i < object[property].length; i++) {
                    formData.append(`${property}[]`, object[property].item(i));
                }
            }
            else if (typeof object[property] === 'object' && !(object[property] instanceof File)) {
                this.createFormData(object[property], formData, formKey);
            }
            else {
                formData.append(formKey, object[property]);
            }
        }
        return formData;
    }
    /**
     * Upload the file list
     */
    upload(method, url, files, options) {
        method = method.toLowerCase();
        if (['post', 'put'].indexOf(method) === -1) {
            throw new Error(`FileUpload: Method "${method}" not allow, use "POST" or "PUT"`);
        }
        let result = { state: null, files: files, total: 0, loaded: 0, progress: 0 };
        const Params = {};
        Params[options.listParameterName ? options.listParameterName : 'files'] = files;
        const res = new HttpRequest(method, url, this.createFormData(options.params ? Object.assign(Object.assign({}, Params), options.params) : Params), { reportProgress: true, headers: new HttpHeaders(options.headers ? options.headers : {}) });
        return this.http
            .request(res)
            .pipe(map((event) => {
            switch (event.type) {
                case HttpEventType.Sent:
                    result = Object.assign(Object.assign({}, result), { state: FileUploadState.initialize });
                    break;
                case HttpEventType.UploadProgress:
                    result = Object.assign(Object.assign({}, result), {
                        state: event.total !== event.loaded ? FileUploadState.inProgress : FileUploadState.completed,
                        total: event.total,
                        loaded: event.loaded,
                        progress: Math.round(100 * event.loaded / event.total)
                    });
                    break;
                case HttpEventType.Response:
                    if (result.state !== FileUploadState.completed) {
                        result = Object.assign(Object.assign({}, result), { state: FileUploadState.completed });
                    }
                    break;
            }
            return result;
        }), filter((val) => !isNullOrUndefined(val)), distinctUntilChanged());
    }
    /**
     * Upload the files using POST HTTP method
     */
    post(url, files, options) {
        return this.upload('post', url, files, options);
    }
    /**
     * Upload the files using PUT HTTP method
     */
    put(url, files, options) {
        return this.upload('put', url, files, options);
    }
}
/** @nocollapse */ FileUpload.ɵfac = function FileUpload_Factory(t) { return new (t || FileUpload)(i0.ɵɵinject(i1.HttpClient)); };
/** @nocollapse */ FileUpload.ɵprov = i0.ɵɵdefineInjectable({ token: FileUpload, factory: FileUpload.ɵfac });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(FileUpload, [{
        type: Injectable
    }], function () { return [{ type: i1.HttpClient }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS11cGxvYWQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1yZXN0LyIsInNvdXJjZXMiOlsibGliL2ZpbGUtdXBsb2FkLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsYUFBYSxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUUzRixPQUFPLEVBQUUsR0FBRyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLE1BQU0sQ0FBQzs7O0FBV3pDOztHQUVHO0FBQ0gsTUFBTSxDQUFOLElBQVksZUFJWDtBQUpELFdBQVksZUFBZTtJQUN2Qiw0Q0FBeUIsQ0FBQTtJQUN6Qiw0Q0FBeUIsQ0FBQTtJQUN6QiwwQ0FBdUIsQ0FBQTtBQUMzQixDQUFDLEVBSlcsZUFBZSxLQUFmLGVBQWUsUUFJMUI7QUFHRCxNQUFNLE9BQU8sVUFBVTtJQUVuQjs7T0FFRztJQUNILFlBQXFCLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENBQVk7SUFBTSxDQUFDO0lBRTVDOztPQUVHO0lBQ0ksTUFBTSxDQUFDLG1CQUFtQixDQUFDLEtBQWE7UUFDM0MsTUFBTSxDQUFDLEdBQUcsQ0FBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUUsR0FBRyxDQUFDLENBQUM7UUFDbEQsT0FBTyxDQUFDLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFD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SyxNQUFNLENBQUMsS0FBSyxLQUFLLGVBQWUsQ0FBQyxTQUFTLEVBQUc7d0JBQzlDLE1BQU0sbUNBQVEsTUFBTSxHQUFLLEVBQUUsS0FBSyxFQUFFLGVBQWUsQ0FBQyxTQUFTLEVBQUUsQ0FBRSxDQUFDO3FCQUNuRTtvQkFDRCxNQUFNO2FBQ2I7WUFDRCxPQUFPLE1BQU0sQ0FBQztRQUNsQixDQUFDLENBQUMsRUFDRixNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUMsRUFDeEMsb0JBQW9CLEVBQUUsQ0FDekIsQ0FBQztJQUNWLENBQUM7SUFFRDs7T0FFRztJQUNJLElBQUksQ0FBRSxHQUFXLEVBQUUsS0FBZSxFQUFFLE9BQXdCO1FBQy9ELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRUQ7O09BRUc7SUFDSSxHQUFHLENBQUUsR0FBVyxFQUFFLEtBQWUsRUFBRSxPQUF3QjtRQUM5RCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDbkQsQ0FBQzs7dUZBcEhRLFVBQVU7cUVBQVYsVUFBVSxXQUFWLFVBQVU7a0RBQVYsVUFBVTtjQUR0QixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEV2ZW50VHlwZSwgSHR0cFJlcXVlc3QsIEh0dHBIZWFkZXJzIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgaXNOdWxsT3JVbmRlZmluZWQgfSBmcm9tICd1dGlsJztcblxuLyoqXG4gKiBGaWxlVXBsb2FkIHJlcXVlc3Qgb3B0aW9ucyBzdHJ1Y3R1cmVcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJVXBsb2FkT3B0aW9ucyB7XG4gICAgbGlzdFBhcmFtZXRlck5hbWU/OiBhbnk7XG4gICAgcGFyYW1zPzoge1trZXk6IHN0cmluZ106IGFueX07XG4gICAgaGVhZGVycz86IGFueTtcbn1cblxuLyoqXG4gKiBGaWxlVXBsb2FkIHJlcXVlc3Qgc3RhdGUgZW51bVxuICovXG5leHBvcnQgZW51bSBGaWxlVXBsb2FkU3RhdGUge1xuICAgIGluaXRpYWxpemUgPSAnaW5pdGlhbGl6ZScsXG4gICAgaW5Qcm9ncmVzcyA9ICdpblByb2dyZXNzJyxcbiAgICBjb21wbGV0ZWQgPSAnY29tcGxldGVkJ1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRmlsZVVwbG9hZCB7XG5cbiAgICAvKipcbiAgICAgKiBTZXJ2aWNlIGNsYXNzIGNvbnN0cnVjdG9yXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCApIHsgIH1cblxuICAgIC8qKlxuICAgICAqIENvbnZlcnQgYnl0ZXMgc2l6ZSB0byBodW1hbiByZWFkYWJsZSBmb3JtYXRcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGh1bWFuUmVhZGFibGVGb3JtYXQoYnl0ZXM6IG51bWJlcikge1xuICAgICAgICBjb25zdCBlID0gKCBNYXRoLmxvZyhieXRlcykgLyBNYXRoLmxvZygxZTMpICkgfCAwO1xuICAgICAgICByZXR1cm4gKyhieXRlcyAvIE1hdGgucG93KDFlMywgZSkpLnRvRml4ZWQoMikgKyAnICcgKyAoJ2tNR1RQRVpZJ1tlIC0gMV0gfHwgJycpICsgJ0InO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENvbnZlcnQgYnl0ZXMgc2l6ZSB0byBodW1hbiByZWFkYWJsZSBmb3JtYXRcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGNhbGN1bGF0ZVNpemUoZmlsZXM6IEZpbGVMaXN0KSB7XG4gICAgICAgIGxldCBzaXplID0gMDtcbiAgICAgICAgQXJyYXkuZnJvbShmaWxlcykuZm9yRWFjaCgoZmlsZSkgPT4geyBzaXplICs9IGZpbGUuc2l6ZTsgfSk7XG4gICAgICAgIHJldHVybiBzaXplO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIEZvcm1EYXRhIG9iamVjdCB0byBiZSBzZW5kIGFzIHJlcXVlc3QgcGF5bG9hZCBkYXRhXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGNyZWF0ZUZvcm1EYXRhKG9iamVjdDogYW55LCBmb3JtPzogRm9ybURhdGEsIG5hbWVzcGFjZT86IHN0cmluZyk6IEZvcm1EYXRhIHtcbiAgICAgICAgY29uc3QgZm9ybURhdGEgPSBmb3JtIHx8IG5ldyBGb3JtRGF0YSgpO1xuXG4gICAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgaW4gb2JqZWN0KSB7XG5cbiAgICAgICAgICAgIGlmICghb2JqZWN0Lmhhc093blByb3BlcnR5KHByb3BlcnR5KSB8fCAhb2JqZWN0W3Byb3BlcnR5XSkgeyBjb250aW51ZTsgfVxuXG4gICAgICAgICAgICBjb25zdCBmb3JtS2V5ID0gbmFtZXNwYWNlID8gYCR7bmFtZXNwYWNlfVske3Byb3BlcnR5fV1gIDogcHJvcGVydHk7XG4gICAgICAgICAgICBpZiAob2JqZWN0W3Byb3BlcnR5XSBpbnN0YW5jZW9mIERhdGUpIHtcbiAgICAgICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoZm9ybUtleSwgb2JqZWN0W3Byb3BlcnR5XS50b0lTT1N0cmluZygpKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIG9iamVjdFtwcm9wZXJ0eV0gaW5zdGFuY2VvZiBGaWxlTGlzdCApIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9iamVjdFtwcm9wZXJ0eV0ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKGAke3Byb3BlcnR5fVtdYCwgb2JqZWN0W3Byb3BlcnR5XS5pdGVtKGkpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKFxuICAgICAgICAgICAgICAgIHR5cGVvZiBvYmplY3RbcHJvcGVydHldID09PSAnb2JqZWN0JyAmJiAhKG9iamVjdFtwcm9wZXJ0eV0gaW5zdGFuY2VvZiBGaWxlKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlRm9ybURhdGEob2JqZWN0W3Byb3BlcnR5XSwgZm9ybURhdGEsIGZvcm1LZXkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoZm9ybUtleSwgb2JqZWN0W3Byb3BlcnR5XSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZvcm1EYXRhO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwbG9hZCB0aGUgZmlsZSBsaXN0XG4gICAgICovXG4gICAgcHJpdmF0ZSB1cGxvYWQoIG1ldGhvZDogc3RyaW5nLCB1cmw6IHN0cmluZywgZmlsZXM6IEZpbGVMaXN0LCBvcHRpb25zPzogSVVwbG9hZE9wdGlvbnMgKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgbWV0aG9kID0gbWV0aG9kLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIGlmICggWyAncG9zdCcsICdwdXQnIF0uaW5kZXhPZiggbWV0aG9kICkgPT09IC0xICkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWxlVXBsb2FkOiBNZXRob2QgXCIkeyBtZXRob2QgfVwiIG5vdCBhbGxvdywgdXNlIFwiUE9TVFwiIG9yIFwiUFVUXCJgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCByZXN1bHQgPSB7IHN0YXRlOiBudWxsLCBmaWxlczogZmlsZXMsIHRvdGFsOiAwLCBsb2FkZWQ6IDAsIHByb2dyZXNzOiAwIH07XG5cbiAgICAgICAgY29uc3QgUGFyYW1zID0geyAgfTtcblxuICAgICAgICBQYXJhbXNbb3B0aW9ucy5saXN0UGFyYW1ldGVyTmFtZSA/IG9wdGlvbnMubGlzdFBhcmFtZXRlck5hbWUgOiAnZmlsZXMnXSA9IGZpbGVzO1xuXG4gICAgICAgIGNvbnN0IHJlcyA9IG5ldyBIdHRwUmVxdWVzdChcbiAgICAgICAgICAgIG1ldGhvZCwgdXJsLFxuICAgICAgICAgICAgdGhpcy5jcmVhdGVGb3JtRGF0YSggb3B0aW9ucy5wYXJhbXMgPyB7IC4uLlBhcmFtcywgLi4ub3B0aW9ucy5wYXJhbXMgfSA6IFBhcmFtcyApLFxuICAgICAgICAgICAgeyByZXBvcnRQcm9ncmVzczogdHJ1ZSwgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKG9wdGlvbnMuaGVhZGVycyA/IG9wdGlvbnMuaGVhZGVycyA6IHt9KSB9XG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgICAgICAgLnJlcXVlc3QocmVzKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKCggZXZlbnQgKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZXZlbnQudHlwZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBIdHRwRXZlbnRUeXBlLlNlbnQ6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0geyAuLi5yZXN1bHQsIC4uLnsgc3RhdGU6IEZpbGVVcGxvYWRTdGF0ZS5pbml0aWFsaXplIH0gfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgSHR0cEV2ZW50VHlwZS5VcGxvYWRQcm9ncmVzczpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLnJlc3VsdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4ue1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGU6IGV2ZW50LnRvdGFsICE9PSBldmVudC5sb2FkZWQgPyBGaWxlVXBsb2FkU3RhdGUuaW5Qcm9ncmVzcyA6IEZpbGVVcGxvYWRTdGF0ZS5jb21wbGV0ZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbDogZXZlbnQudG90YWwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkZWQ6IGV2ZW50LmxvYWRlZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzOiBNYXRoLnJvdW5kKDEwMCAqIGV2ZW50LmxvYWRlZCAvIGV2ZW50LnRvdGFsKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgSHR0cEV2ZW50VHlwZS5SZXNwb25zZTpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHJlc3VsdC5zdGF0ZSAhPT0gRmlsZVVwbG9hZFN0YXRlLmNvbXBsZXRlZCApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0geyAuLi5yZXN1bHQsIC4uLnsgc3RhdGU6IEZpbGVVcGxvYWRTdGF0ZS5jb21wbGV0ZWQgfSB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGZpbHRlcigodmFsKSA9PiAhaXNOdWxsT3JVbmRlZmluZWQodmFsKSksXG4gICAgICAgICAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGxvYWQgdGhlIGZpbGVzIHVzaW5nIFBPU1QgSFRUUCBtZXRob2RcbiAgICAgKi9cbiAgICBwdWJsaWMgcG9zdCggdXJsOiBzdHJpbmcsIGZpbGVzOiBGaWxlTGlzdCwgb3B0aW9ucz86IElVcGxvYWRPcHRpb25zICk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnVwbG9hZCgncG9zdCcsIHVybCwgZmlsZXMsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwbG9hZCB0aGUgZmlsZXMgdXNpbmcgUFVUIEhUVFAgbWV0aG9kXG4gICAgICovXG4gICAgcHVibGljIHB1dCggdXJsOiBzdHJpbmcsIGZpbGVzOiBGaWxlTGlzdCwgb3B0aW9ucz86IElVcGxvYWRPcHRpb25zICk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnVwbG9hZCgncHV0JywgdXJsLCBmaWxlcywgb3B0aW9ucyk7XG4gICAgfVxuXG59XG4iXX0=